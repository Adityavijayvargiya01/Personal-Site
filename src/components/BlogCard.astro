---
import type { CollectionEntry } from 'astro:content'
import { formatDate } from '@/lib/utils'
import { getPostReadingTime, hasSubposts, getSubpostCount } from '@/lib/data-utils'
import { badgeVariants } from '@/components/ui/badge'
import { cn } from '@/lib/utils'

interface Props {
  entry: CollectionEntry<'blog'>
}

const { entry } = Astro.props
const hasChildPosts = await hasSubposts(entry.id)
const subpostCount = hasChildPosts ? await getSubpostCount(entry.id) : 0
const readingTime = await getPostReadingTime(entry.id)
---

<article class="transition-smooth group">
  <a
    href={`/blog/${entry.id}`}
    class="block rounded-lg border-2 p-4 hover:border-primary/50"
  >
    <div class="flex flex-col gap-2">
      <h3 class="text-lg font-medium group-hover:text-primary transition-colors">
        {entry.data.title}
      </h3>
      <p class="text-muted-foreground text-sm line-clamp-2">
        {entry.data.description}
      </p>
      <div class="flex flex-wrap items-center gap-2 text-xs text-muted-foreground">
        <time datetime={entry.data.date.toISOString()}>
          {formatDate(entry.data.date)}
        </time>
        <span>•</span>
        <span>{readingTime}</span>
        {hasChildPosts && (
          <>
            <span>•</span>
            <span>{subpostCount} part{subpostCount !== 1 ? 's' : ''}</span>
          </>
        )}
        {entry.data.tags && entry.data.tags.length > 0 && (
          <>
            <span>•</span>
            <div class="flex flex-wrap gap-1">
              {entry.data.tags.slice(0, 3).map((tag) => (
                <span
                  class={cn(
                    badgeVariants({ variant: 'secondary' }),
                    'text-xs px-2 py-0.5'
                  )}
                >
                  {tag}
                </span>
              ))}
              {entry.data.tags.length > 3 && (
                <span class="text-muted-foreground">
                  +{entry.data.tags.length - 3}
                </span>
              )}
            </div>
          </>
        )}
      </div>
    </div>
  </a>
</article>
